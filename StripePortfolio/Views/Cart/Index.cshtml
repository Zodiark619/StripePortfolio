<h2>My Cart</h2>
<ul id="cartItems"></ul>
<p id="cartTotal"></p>
<button onclick="checkoutCart()">Checkout</button>
<button onclick="clearCart()">Clear Cart</button>
<script>
    async function loadCart() {
        try {
            const res = await fetch('/api/cart/my-cart');
            if (!res.ok) throw new Error("Failed to fetch cart");

            const cart = await res.json();

            const cartContainer = document.getElementById("cartItems");
            const totalEl = document.getElementById("cartTotal");

            // Clear previous content
            cartContainer.innerHTML = "";
            totalEl.textContent = "";

            if (!cart.items || cart.items.length === 0) {
                const li = document.createElement("li");
                li.textContent = "Your cart is empty";
                cartContainer.appendChild(li);
                return;
            }

            let total = 0;

            cart.items.forEach(item => {
                
                const li = document.createElement("li");
             
      li.innerHTML = `
      <span id="name-${item.productId}" style="display:none;">${item.productName}</span>
      <span id="qty-hidden-${item.productId}" style="display:none;">
        ${item.quantity}
    </span>
        ${item.productName} - $${item.unitPrice.toFixed(2)}
        <br>
        Qty:
        <input type="number" id="qty-${item.productId}" value="${item.quantity}" min="1" style="width:60px;">
        <button onclick="updateQuantity(${item.productId})">Update</button>
        <button onclick="removeItem(${item.productId})" style="margin-left:10px;">Remove</button>
        <br>
        Item Total: $${item.totalPrice.toFixed(2)}
        <hr>
    `;
                cartContainer.appendChild(li);

                total += item.totalPrice;
            });

            totalEl.textContent = `Total: $${total.toFixed(2)}`;

        } catch (err) {
            console.error(err);
            const cartContainer = document.getElementById("cartItems");
            cartContainer.innerHTML = "<li>Unable to load cart items</li>";
        }
    }

    // Call the function on page load
    loadCart();
       
            async function checkoutCart() {
        const res = await fetch('/api/cart/my-cart');
        const cart = await res.json();

        // Convert cartDto → BuyRequest
        const buyRequest = {
            items: cart.items.map(i => ({
                productId: i.productId,
                quantity: i.quantity
            }))
        };

        const checkout = await fetch('/api/checkout/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(buyRequest)
        });

        const data = await checkout.json();
        window.location = data.url;
    }

        
        async function removeItem(productId) {
        //if (!confirm("Remove this item from your cart?")) return;
         const productName = document.getElementById(`name-${productId}`).innerText;
            Swal.fire({
      title: `Removing ${productName} from cart?`,
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, remove it!"
    }).then(async (result) => {
      if (result.isConfirmed) {
             const res = await fetch(`/api/cart/remove/${productId}`, {
             method: "DELETE"
         });
         if(res.ok){
                Swal.fire({
                    title: "Removed!",
                    text: "Item has been removed from the cart.",
                    icon: "success",
                    timer: 1500,
                    showConfirmButton: false
                });

                loadCart();
         }else{
              Swal.fire({
                    title: "Error",
                    text: "Failed to remove item.",
                    icon: "error"
                });
         }
      }
    });
      //   const res = await fetch(`/api/cart/remove/${productId}`, {
      //       method: "DELETE"
      //   });

      //   if (!res.ok) {
      //               Swal.fire({
      //     toast: true,
      //     position: "top-end",
      //     icon: "error",
      //     title: "Failed to remove",
      //     showConfirmButton: false,
      //     timer: 1500
      // });
      //       return;
      //   }

      //   loadCart(); 

    }
        async function clearCart() {
        if (!confirm("Clear your entire cart?")) return;

        const res = await fetch(`/api/cart/clear`, {
            method: "DELETE"
        });

        if (!res.ok) {
                     Swal.fire({
          toast: true,
          position: "top-end",
          icon: "error",
          title: "Fail to clear cart",
          showConfirmButton: false,
          timer: 1500
      });
            return;
        }
                 Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: "Cart content cleared",
          showConfirmButton: false,
          timer: 1500
      });
        loadCart(); // refresh
    }
        async function updateQuantity(productId) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        const newQty = parseInt(qtyInput.value);
        const productName = document.getElementById(`name-${productId}`).innerText;
        const oldQty = parseInt(document.getElementById(`qty-hidden-${productId}`).innerText);
        if (newQty <= 0) {
                     Swal.fire({
          toast: true,
          position: "top-end",
          icon: "error",
          title: "Quantity must at least 1",
          showConfirmButton: false,
          timer: 1500
      });
            return;
        }

        const res = await fetch(`/api/cart/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                productId: productId,
                quantity: newQty
            })
        });

        if (!res.ok) {
                     Swal.fire({
          toast: true,
          position: "top-end",
          icon: "error",
          title: "Failed to update quantity",
          showConfirmButton: false,
          timer: 1500
      });
            return;
        }
          Swal.fire({
          title: "Success",
          text:   `${productName} quantity updated from ${oldQty} to ${newQty}`,
          icon: "success",
         // timer: 1500,
        //  showConfirmButton: true
      });
        loadCart(); // refresh cart
    }

</script>
